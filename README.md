## Next Sheet CMS

A dual-facing Next.js site that reads and writes blog content and admin credentials from a single Google Sheet. The public landing page showcases published posts sourced from the sheet (including ones generated by n8n automations). The admin area provides a JWT-protected dashboard for creating, editing, and deleting posts without exposing credentials client-side.

---

## Features

- **Google Sheets as CMS**: Single spreadsheet contains posts and admin users. CRUD operations go through server-side helpers using a service account.
- **Automated content friendly**: Blog entries follow the structure n8n outputs (`title`, `meta_description`, `outline`, `blog_post`, `tags`).
- **Admin dashboard**: JWT-authenticated interface for managing posts, previewing outlines, toggling publish state, and deleting entries.
- **Mobile-first landing**: Content-rich homepage with sticky bottom navigation on mobile, featured posts, and contact form stub.
- **Dynamic SEO assets**: Sitemap and RSS feed generated from the sheet with automatic revalidation after mutations.
- **Server-only secrets**: Service account credentials and JWT secret never leave the server runtime.

---

## Prerequisites

- Node.js 18.18+ or 20+
- A Google Cloud project with a service account that can read/write Google Sheets
- A Google Sheet with two tabs for posts and admin users

---

## Google Sheet Structure

Create a spreadsheet with (at minimum) two worksheets named `Posts` and `Admins` (or provide custom names via env vars).

### `Posts` tab (row 1 should contain headers in this exact order):

| Column | Description |
| ------ | ----------- |
| `id` | UUID for the row (auto-generated when creating via dashboard/API). |
| `slug` | URL slug (auto-generated from title if blank). |
| `title` | Post title. |
| `meta_title` | Optional meta title override. |
| `meta_description` | Short excerpt for SEO, feeds, and cards. |
| `outline` | JSON array or newline-delimited outline entries. |
| `content` | Markdown body of the post. |
| `tags` | JSON array or comma-separated tag list. |
| `status` | `draft`, `scheduled`, `published`, or `archived`. Only `published` entries appear publicly. |
| `cover_image` | Optional image URL. |
| `created_at` | ISO timestamp. |
| `updated_at` | ISO timestamp (filled automatically). |
| `published_at` | ISO timestamp (auto-set when status becomes `published`). |
| `author` | Optional author name. |

### `Admins` tab headers:

| Column          | Description                                              |
| --------------- | -------------------------------------------------------- |
| `id`            | UUID for the admin row.                                  |
| `email`         | Lowercase email used to sign in.                         |
| `password_hash` | Bcrypt hash (see below for generating).                  |
| `role`          | `admin` or `editor`.                                     |
| `active`        | `TRUE` or `FALSE`. Inactive users cannot sign in.        |
| `last_login_at` | ISO timestamp automatically updated on successful login. |

> **Tip:** n8n can append JSON directly; the helpers attempt to parse arrays from either JSON or simple delimiters.

---

## Environment Variables

Create an `.env.local` (not committed) with:

```
GOOGLE_SHEET_ID=1AbC...your-sheet-id...
GOOGLE_SERVICE_ACCOUNT_EMAIL=service-account@project.iam.gserviceaccount.com
GOOGLE_SERVICE_ACCOUNT_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
GOOGLE_SHEETS_POSTS_TAB=Posts              # optional override
GOOGLE_SHEETS_ADMINS_TAB=Admins            # optional override
JWT_SECRET=super-long-random-string
NEXT_PUBLIC_SITE_URL=https://yourdomain.com
```

### Service Account Access

1. In Google Cloud Console create a service account.
2. Grant it the “Editor” role (or minimally “Sheets Editor”).
3. Create a JSON key and copy the `client_email` + `private_key` into the env vars.
4. Share the Google Sheet with the service account email (Editor permissions).

### Generating Password Hashes

Passwords stored in the sheet must be bcrypt hashes. From the project root:

```bash
node -e "console.log(require('bcryptjs').hashSync('Admin@2002Done', 10))"
```

Paste the resulting hash into the `password_hash` column.

---

## Development

Install dependencies (already run if you executed the initial commands):

```bash
npm install
```

Run the dev server:

```bash
npm run dev
```

Visit `http://localhost:3000` for the public site and `http://localhost:3000/admin/login` for the admin portal.

---

## Admin Workflow

1. Sign in with credentials present in the `Admins` tab.
2. The session cookie (`admin_session`) stores a signed JWT for 8 hours.
3. Create, edit, or delete posts. All mutations trigger revalidation of:
   - Landing page (`/`)
   - Blog index (`/blog`)
   - Individual blog routes (`/blog/[slug]`)
   - `sitemap.xml` and `rss.xml`

---

## API Reference

| Method | Route | Description | Auth |
| ------ | ----- | ----------- | ---- |
| `GET` | `/api/posts` | List all posts (any status). | Public |
| `POST` | `/api/posts` | Create a post. Accepts same payload as admin form. | Requires admin session |
| `GET` | `/api/posts/:id` | Retrieve one post by `id`. | Public |
| `PUT` | `/api/posts/:id` | Update a post. | Requires admin session |
| `DELETE` | `/api/posts/:id` | Remove a post from the sheet (row is cleared). | Requires admin session |
| `POST` | `/api/auth/login` | Sign in; sets `admin_session` cookie. | Public |
| `POST` | `/api/auth/logout` | Clears the session cookie. | Requires session |

Requests made from the admin UI include credentials automatically. External tools can send the JWT in an `Authorization: Bearer <token>` header.

---

## Deployment Notes

- Set all environment variables in your hosting platform (Vercel, Render, etc.).
- Ensure the service account can reach the sheet from the hosted environment.
- Use `NEXT_PUBLIC_SITE_URL` so sitemap/RSS emit canonical URLs.
- Production cookies are `secure` and `httpOnly`; use HTTPS locally if testing cross-origin requests.

---

## Testing Checkpoints

- `npm run lint` — ESLint (already configured).
- Manual smoke tests:
  - Load `/` and `/blog`.
  - Sign in at `/admin/login`, create a post, verify sitemap/RSS update after revalidation window.
  - Confirm unauthorized POST/PUT/DELETE requests return 401.

---

## Extending

- Add role-based permissions (e.g., restrict editors from deleting posts).
- Hook revalidation into n8n webhooks after a sheet update.
- Swap Formspree placeholder with your preferred form handler or CRM.
- Integrate image uploads and store URLs in the sheet.
